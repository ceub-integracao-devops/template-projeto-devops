name: Build and Deploy to Koyeb

on:
  push:
    branches: [ "main" ]

permissions:
  contents: read
  packages: write

env:
  KOYEB_APP: "app-hello"
  KOYEB_SERVICE: "web"
  EXPOSE_PORT: "8000"
  HEALTHCHECK_URL: ""
  KOYEB_VERSION: "5.9.0"
  IMAGE_NAME: ghcr.io/${{ github.repository }}:sha-${{ github.sha }}

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Login GHCR
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Build and push image
        run: |
          set -euo pipefail
          docker build -t "$IMAGE_NAME" .
          docker push "$IMAGE_NAME"

  deploy:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Install Koyeb CLI
        env:
          KOYEB_VERSION: ${{ env.KOYEB_VERSION }}
        run: |
          set -euo pipefail
          ver="${KOYEB_VERSION}"
          url="https://github.com/koyeb/koyeb-cli/releases/download/v${ver}/koyeb-cli_${ver}_linux_amd64.tar.gz"
          tmp="$(mktemp -d)"
          curl -fsSL "$url" -o "$tmp/koyeb.tar.gz"
          tar -xzf "$tmp/koyeb.tar.gz" -C "$tmp" || true
          if [ -f "$tmp/koyeb.tgz" ]; then tar -xzf "$tmp/koyeb.tgz" -C "$tmp"; fi
          bin="$(find "$tmp" -maxdepth 2 -type f -name 'koyeb' | head -n1 || true)"
          if [ -z "${bin:-}" ]; then
            echo "koyeb binary not found"; ls -la "$tmp"; exit 1
          fi
          chmod +x "$bin"
          mkdir -p "$HOME/.local/bin"
          mv "$bin" "$HOME/.local/bin/koyeb"
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"
          # Checagem sem --version
          koyeb version || koyeb --help | head -n 20

      - name: Koyeb CLI Login
        env:
          KOYEB_TOKEN: ${{ secrets.KOYEB_TOKEN }}
        run: |
          set -euo pipefail
          cfg="${XDG_CONFIG_HOME:-$HOME/.config}/koyeb/config.json"
          mkdir -p "$(dirname "$cfg")"

          if koyeb login --help 2>&1 | grep -q -- '--access-token'; then
            koyeb login --access-token "${KOYEB_TOKEN}" --no-browse
          else
            printf '{"access_token":"%s"}\n' "${KOYEB_TOKEN}" > "$cfg"
          fi

          # Evite subcomandos que podem não existir; apenas confirme que está funcional:
          koyeb version || koyeb --help | head -n 10

      # Step de deploy real será ajustado após confirmarmos os subcomandos suportados na sua CLI
      - name: Show Koyeb help (para mapear comandos)
        run: |
          set -euo pipefail
          koyeb --help
          echo "===="
          koyeb service --help || true
          echo "===="
          koyeb services --help || true