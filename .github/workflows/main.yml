name: ci-cd

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

env:
  KOYEB_APP: "app-hello"
  KOYEB_SERVICE: "web"
  EXPOSE_PORT: "8000"
  HEALTHCHECK_URL: ""
  KOYEB_VERSION: "5.9.0"
  IMAGE_NAME: ghcr.io/${{ github.repository }}:sha-${{ github.sha }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: ${{ env.IMAGE_NAME }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            EXPOSE_PORT=${{ env.EXPOSE_PORT }}

      - name: Install Koyeb CLI
        env:
          KOYEB_VERSION: ${{ env.KOYEB_VERSION }}
        run: |
          set -euo pipefail

          tmpdir="$(mktemp -d)"
          cd "$tmpdir"

          URL="https://github.com/koyeb/koyeb-cli/releases/download/v${KOYEB_VERSION}/koyeb-cli_${KOYEB_VERSION}_linux_amd64.tar.gz"
          echo "Baixando: $URL"
          curl -fsSL "$URL" -o koyeb.tar.gz

          tar -xzf koyeb.tar.gz || true
          if [ -f koyeb.tgz ]; then
            tar -xzf koyeb.tgz
          fi

          binpath="$(find . -maxdepth 2 -type f -name 'koyeb' -perm -u+x | head -n1 || true)"
          if [ -z "${binpath:-}" ]; then
            echo "Binário 'koyeb' não encontrado após extração"
            ls -la
            exit 1
          fi

          sudo install -m 0755 "$binpath" /usr/local/bin/koyeb
          koyeb --version
          koyeb --help | sed -n '1,40p'

      - name: Login to Koyeb (non-interactive)
        env:
          KOYEB_TOKEN: ${{ secrets.KOYEB_TOKEN }}
        run: |
          set -euo pipefail
          set +x
          LOGIN_OK=0

          if koyeb login --help 2>&1 | grep -q -- '--access-token'; then
            if koyeb login --access-token "$KOYEB_TOKEN" --no-browser >/dev/null 2>&1; then
              LOGIN_OK=1
            fi
          fi

          if [ "$LOGIN_OK" -ne 1 ]; then
            mkdir -p "$HOME/.config/koyeb"
            printf '{"access_token":"%s"}' "$KOYEB_TOKEN" > "$HOME/.config/koyeb/config.json"
          fi

          set -x
          if ! koyeb apps list >/dev/null 2>&1; then
            echo "Falha ao autenticar na Koyeb CLI com o token fornecido."
            exit 1
          fi
          echo "Autenticação Koyeb OK."

      # ——— AQUI entram seus comandos de deploy Koyeb ———
      # Ex.: criar app/serviço, atualizar imagem, etc.
      # Deixe como já está no seu workflow, apenas remova 'account'/'auth' do login.
      # -------------------------------------------------