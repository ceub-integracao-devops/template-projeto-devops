name: Build and Deploy to Koyeb

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  # Ajuste estes valores conforme o seu ambiente
  KOYEB_APP: app-hello
  KOYEB_SERVICE: web
  KOYEB_PORT: 8000

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push image (GHCR)
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: linux/amd64
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:sha-${{ github.sha }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Install Koyeb CLI v5.9.0
        run: |
          set -euo pipefail
          KOYEB_VERSION=5.9.0
          curl -fsSL -o /tmp/koyeb.tar.gz "https://github.com/koyeb/koyeb-cli/releases/download/v${KOYEB_VERSION}/koyeb-cli_${KOYEB_VERSION}_linux_amd64.tar.gz"
          tar -xzf /tmp/koyeb.tar.gz -C /tmp
          sudo mv /tmp/koyeb /usr/local/bin/koyeb
          koyeb version
          koyeb --help | head -n 20

      - name: Configure Koyeb CLI (non-interactive)
        env:
          KOYEB_TOKEN: ${{ secrets.KOYEB_TOKEN }}
          KOYEB_ORG: ${{ secrets.KOYEB_ORG }}
        run: |
          set -euo pipefail
          mkdir -p "$HOME"
          # Cria ~/.koyeb.yaml com o token (e org se definido)
          {
            echo "token: "${KOYEB_TOKEN}""
            if [ -n "${KOYEB_ORG:-}" ]; then
              echo "organization: "${KOYEB_ORG}""
            fi
            echo "url: "https://app.koyeb.com""
            echo "output: "human""
          } > "$HOME/.koyeb.yaml"
          # Sanity check com um comando simples
          koyeb apps list -o table || true

      - name: Create/Update Koyeb app and service
        env:
          IMAGE_SHA: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:sha-${{ github.sha }}
          KOYEB_APP: ${{ env.KOYEB_APP }}
          KOYEB_SERVICE: ${{ env.KOYEB_SERVICE }}
          KOYEB_PORT: ${{ env.KOYEB_PORT }}
        run: |
          set -euo pipefail

          echo "Garantindo que o app '${KOYEB_APP}' exista..."
          if koyeb apps describe "${KOYEB_APP}" >/dev/null 2>&1; then
            echo "App já existe."
          else
            echo "Criando app '${KOYEB_APP}'..."
            koyeb apps create "${KOYEB_APP}"
          fi

          echo "Garantindo que o serviço '${KOYEB_APP}/${KOYEB_SERVICE}' exista..."
          if koyeb services describe "${KOYEB_APP}/${KOYEB_SERVICE}" >/dev/null 2>&1; then
            echo "Serviço existe. Criando novo deployment com a imagem ${IMAGE_SHA}..."
            koyeb deployments create \
              --service "${KOYEB_APP}/${KOYEB_SERVICE}" \
              --image "${IMAGE_SHA}"
          else
            echo "Criando serviço '${KOYEB_SERVICE}' no app '${KOYEB_APP}' com a imagem ${IMAGE_SHA}..."
            koyeb services create "${KOYEB_SERVICE}" \
              --app "${KOYEB_APP}" \
              --image "${IMAGE_SHA}" \
              --ports "${KOYEB_PORT}:http"
              # Adicione envs se necessário repetindo --env KEY=VALUE
              # Ex: --env NODE_ENV=production --env API_URL=https://...
          fi

          echo "Descrição do serviço após a operação:"
          koyeb services describe "${KOYEB_APP}/${KOYEB_SERVICE}" -o yaml || true