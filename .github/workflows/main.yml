name: Build and Deploy to Koyeb

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

# Necessário para push no GHCR
permissions:
  contents: read
  packages: write

env:
  # Ajuste os nomes abaixo para seu app/serviço na Koyeb
  KOYEB_APP: app-hello
  KOYEB_SERVICE: web
  # Imagem publicada; o serviço na Koyeb deve apontar para :latest
  IMAGE_LATEST: ghcr.io/${{ github.repository }}:latest
  IMAGE_SHA: ghcr.io/${{ github.repository }}:sha-${{ github.sha }}

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push image to GHCR (latest + sha)
        run: |
          set -euo pipefail
          docker buildx build \
            --push \
            --platform linux/amd64 \
            -t "${IMAGE_LATEST}" \
            -t "${IMAGE_SHA}" \
            .

      - name: Install Koyeb CLI v5.9.0
        run: |
          set -euo pipefail
          curl -fsSL -o /tmp/koyeb.tar.gz https://github.com/koyeb/koyeb-cli/releases/download/v5.9.0/koyeb-cli_5.9.0_linux_amd64.tar.gz
          tar -C /usr/local/bin -xzf /tmp/koyeb.tar.gz koyeb
          chmod +x /usr/local/bin/koyeb
          # Checagem correta de versão (sem --version)
          koyeb version

      - name: (Opcional) Verificar token e listar serviços
        env:
          KOYEB_TOKEN: ${{ secrets.KOYEB_TOKEN }}
        run: |
          set -euo pipefail
          # Se o token estiver inválido, aqui já falha
          koyeb services list --token "${KOYEB_TOKEN}" >/dev/null

      - name: Redeploy do serviço existente na Koyeb
        env:
          KOYEB_TOKEN: ${{ secrets.KOYEB_TOKEN }}
          KOYEB_APP: ${{ env.KOYEB_APP }}
          KOYEB_SERVICE: ${{ env.KOYEB_SERVICE }}
          KOYEB_ORG: ${{ secrets.KOYEB_ORG_ID }} # opcional
        run: |
          set -euo pipefail
          ORG_FLAG=""
          if [ -n "${KOYEB_ORG:-}" ]; then
            ORG_FLAG="--organization ${KOYEB_ORG}"
          fi

          echo "Descrevendo o serviço antes do redeploy (se não existir, este comando falha):"
          koyeb services describe "${KOYEB_SERVICE}" --app "${KOYEB_APP}" ${ORG_FLAG} --token "${KOYEB_TOKEN}"

          echo "Disparando redeploy para o serviço ${KOYEB_SERVICE} no app ${KOYEB_APP}..."
          # Importante: para o redeploy puxar a sua nova imagem, o serviço deve estar configurado na Koyeb para usar a tag :latest
          koyeb services redeploy "${KOYEB_SERVICE}" --app "${KOYEB_APP}" ${ORG_FLAG} --token "${KOYEB_TOKEN}"