name: CI/CD to Koyeb

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: read
  packages: write

env:
  IMAGE_REGISTRY: ghcr.io
  IMAGE_OWNER: ${{ github.repository_owner }}
  IMAGE_NAME: template-projeto-devops
  KOYEB_APP: app-hello
  KOYEB_SERVICE: web
  KOYEB_PORT: "8080"

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.IMAGE_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push image (sha and latest)
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: |
            ${{ env.IMAGE_REGISTRY }}/${{ env.IMAGE_OWNER }}/${{ env.IMAGE_NAME }}:sha-${{ github.sha }}
            ${{ env.IMAGE_REGISTRY }}/${{ env.IMAGE_OWNER }}/${{ env.IMAGE_NAME }}:latest
          cache-from: type=registry,ref=${{ env.IMAGE_REGISTRY }}/${{ env.IMAGE_OWNER }}/${{ env.IMAGE_NAME }}:buildcache
          cache-to: type=registry,ref=${{ env.IMAGE_REGISTRY }}/${{ env.IMAGE_OWNER }}/${{ env.IMAGE_NAME }}:buildcache,mode=max

      - name: Install Koyeb CLI v5.9.0
        run: |
          set -euo pipefail
          curl -fsSL "https://github.com/koyeb/koyeb-cli/releases/download/v5.9.0/koyeb_5.9.0_Linux_x86_64.tar.gz" -o /tmp/koyeb.tgz
          tar -xzf /tmp/koyeb.tgz -C /tmp
          sudo mv /tmp/koyeb /usr/local/bin/koyeb
          koyeb --help

      - name: Configure Koyeb CLI non-interactive
        run: |
          set -euo pipefail
          mkdir -p "$HOME"
          cat > "$HOME/.koyeb.yaml" <<'EOF'
          api:
            token: "${{ secrets.KOYEB_TOKEN }}"
          organization: "${{ secrets.KOYEB_ORG }}"
          apiUrl: "https://app.koyeb.com"
          EOF
          chmod 600 "$HOME/.koyeb.yaml"
          echo "Config written to $HOME/.koyeb.yaml"

      - name: Ensure app exists
        id: ensure_app
        run: |
          set -euo pipefail
          if koyeb apps get "${{ env.KOYEB_APP }}" >/dev/null 2>&1; then
            echo "app_exists=true" >> "$GITHUB_OUTPUT"
            echo "App exists."
          else
            echo "Creating app ${{ env.KOYEB_APP }}..."
            koyeb apps create "${{ env.KOYEB_APP }}"
            echo "app_exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Create or update service
        run: |
          set -euo pipefail
          APP="${{ env.KOYEB_APP }}"
          SERVICE="${{ env.KOYEB_SERVICE }}"
          IMG="${{ env.IMAGE_REGISTRY }}/${{ env.IMAGE_OWNER }}/${{ env.IMAGE_NAME }}:sha-${{ github.sha }}"
          SERVICE_FQN="${APP}/${SERVICE}"

          echo "Target image: ${IMG}"

          if koyeb services get "${SERVICE_FQN}" >/dev/null 2>&1; then
            echo "Service exists; attempting update..."
            # TODO: Replace the update command with the exact syntax your CLI supports.
            # Example variants (commented until we confirm the right one):
            # koyeb services update "${SERVICE_FQN}" --container-image "${IMG}" --ports "${{ env.KOYEB_PORT }}:http"
            # koyeb services update "${SERVICE_FQN}" --image "${IMG}" --ports "${{ env.KOYEB_PORT }}:http"
            # koyeb services update "${SERVICE_FQN}" --container image="${IMG}" port="${{ env.KOYEB_PORT }}:http"
            echo "Please paste 'koyeb services update --help' output so I can lock the correct flags."
            exit 0
          else
            echo "Service not found; attempting create..."
            # TODO: Replace the create command with the exact syntax your CLI supports.
            # Example variants (commented until we confirm the right one):
            # koyeb services create "${SERVICE}" --app "${APP}" --container-image "${IMG}" --ports "${{ env.KOYEB_PORT }}:http"
            # koyeb services create "${SERVICE}" --app "${APP}" --image "${IMG}" --ports "${{ env.KOYEB_PORT }}:http"
            # koyeb services create "${SERVICE}" --app "${APP}" --container image="${IMG}" port="${{ env.KOYEB_PORT }}:http"
            echo "Please paste 'koyeb services create --help' output so I can lock the correct flags."
            exit 0