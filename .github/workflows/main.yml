name: ci-cd-koyeb

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

permissions:
  contents: read
  packages: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Definir variáveis (owner minúsculo, imagem e tags)
        id: vars
        shell: bash
        run: |
          set -euo pipefail
          OWNER="${GITHUB_REPOSITORY_OWNER}"
          OWNER_LC="$(printf '%s' "$OWNER" | tr '[:upper:]' '[:lower:]')"
          echo "OWNER_LC=$OWNER_LC" >> "$GITHUB_ENV"

          IMAGE="ghcr.io/${OWNER_LC}/app-hello"
          TAG_SHA="${GITHUB_SHA::7}"
          echo "IMAGE=$IMAGE" >> "$GITHUB_ENV"
          echo "TAG_SHA=$TAG_SHA" >> "$GITHUB_ENV"

      - name: Login no GHCR
        if: github.event_name == 'push'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ github.token }}

      - name: Build da imagem (local)
        shell: bash
        run: |
          set -euo pipefail
          docker build \
            -t "${IMAGE}:latest" \
            -t "${IMAGE}:${TAG_SHA}" \
            .

      - name: Push da imagem (somente push em main)
        if: github.event_name == 'push'
        shell: bash
        run: |
          set -euo pipefail
          docker push "${IMAGE}:latest"
          docker push "${IMAGE}:${TAG_SHA}"

      - name: Instalar Koyeb CLI (latest, OS/arch auto)
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y curl jq tar
          OS="$(uname -s | tr '[:upper:]' '[:lower:]')"
          ARCH="$(uname -m)"
          case "$ARCH" in
            x86_64|amd64) A1="amd64"; A2="x86_64" ;;
            aarch64|arm64) A1="arm64"; A2="arm64" ;;
            *) echo "Arquitetura não suportada: $ARCH"; exit 1 ;;
          esac
          API_URL="https://api.github.com/repos/koyeb/koyeb-cli/releases/latest"
          HDR_AUTH=()
          if [ -n "${GH_TOKEN:-}" ]; then
            HDR_AUTH=(-H "Authorization: Bearer ${GH_TOKEN}")
          fi
          JSON="$(curl -fsSL -H "Accept: application/vnd.github+json" "${HDR_AUTH[@]}" "$API_URL")"
          DL_URL="$(echo "$JSON" \
            | jq -r --arg os "$OS" --arg a1 "$A1" --arg a2 "$A2" '
                .assets[]
                | .name as $n
                | select(
                    ($n|ascii_downcase|contains($os))
                    and (
                      ($n|ascii_downcase|contains($a1))
                      or ($n|ascii_downcase|contains($a2))
                    )
                    and ($n|endswith(".tar.gz"))
                  )
                | .browser_download_url
              ' | head -n1)"
          if [ -z "$DL_URL" ] || [ "$DL_URL" = "null" ]; then
            echo "Não encontrei asset para $OS/$ARCH"
            echo "$JSON" | jq -r '.assets[].name'
            exit 1
          fi
          curl -fsSL "$DL_URL" -o /tmp/koyeb.tgz
          tar -xzf /tmp/koyeb.tgz -C /tmp
          sudo install -m 0755 "$(find /tmp -type f -name 'koyeb' | head -n1)" /usr/local/bin/koyeb
          koyeb version

      - name: Deploy no Koyeb (somente push em main)
        if: github.event_name == 'push'
        env:
          KOYEB_TOKEN: ${{ secrets.KOYEB_TOKEN }}
          IMAGE: ${{ env.IMAGE }}
          TAG_SHA: ${{ env.TAG_SHA }}
        shell: bash
        run: |
          set -euo pipefail

          if [ -z "${KOYEB_TOKEN:-}" ]; then
            echo "KOYEB_TOKEN não definido em Secrets."
            exit 1
          fi

          # Login na Koyeb CLI
          koyeb auth login --token "$KOYEB_TOKEN"

          APP_NAME="app-hello"
          SVC_NAME="web"
          IMAGE_REF="${IMAGE}:latest"

          # Se o app não existir, cria
          if ! koyeb app get "$APP_NAME" >/dev/null 2>&1; then
            koyeb app create "$APP_NAME"
          fi

          # Se o serviço não existir, cria. Caso exista, atualiza a imagem
          if ! koyeb service get "$APP_NAME/$SVC_NAME" >/dev/null 2>&1; then
            koyeb service create "$APP_NAME/$SVC_NAME" \
              --docker "$IMAGE_REF" \
              --ports 8080:http
          else
            koyeb service update "$APP_NAME/$SVC_NAME" \
              --docker "$IMAGE_REF"
          fi

          # Opcional: aguardar rollout (descomente para bloquear até ficar saudável)
          # koyeb service rollout status "$APP_NAME/$SVC_NAME" --watch --timeout 300